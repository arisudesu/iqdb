#!/bin/sh

cd /usr/src/packages/sim
export HOME=/opt/iqdb

EC=0
if ! lockfile -r 0 update.lock; then
	echo Failed to obtain lock, aborting.
	exit 1;
fi
trap "rm -f update.lock" SIGHUP SIGINT SIGQUIT SIGTERM EXIT

export http_proxy=http://localhost:3128/

MODE="$1"
if [ "$MODE" = "auto" ]; then
	MODE=`perl -le 'print 2<24*-M $ARGV[0]?"full":"update"' ~/doujin/.lastfullupdate`
fi;
if [ "$MODE" = "update" ]; then
	echo Quick update

	./danbooru-change danbooru   || let EC=$EC+2
	./danbooru-change konachan   || let EC=$EC+2
	./danbooru-change moe.imouto || let EC=$EC+2
	./danbooru-change 4scrape    || let EC=$EC+2
	./danbooru-change sankaku    || let EC=$EC+2
	./danbooru-change e-shuushuu || let EC=$EC+2
	./danbooru-change 3dbooru    || let EC=$EC+2
	./danbooru-change nekobooru  || let EC=$EC+2

	touch ~/doujin/.lastquickupdate ~/doujin/.lastupdate
	exit $EC
elif [ "$MODE" = "full" ]; then
	echo Full update

	./danbooru-change danbooru   full  || let EC=$EC+2
	./danbooru-change konachan   full  || let EC=$EC+2
	./danbooru-change moe.imouto full  || let EC=$EC+2
	./danbooru-change 4scrape          || let EC=$EC+2
	./danbooru-change sankaku    full  || let EC=$EC+2
	./danbooru-change e-shuushuu full  || let EC=$EC+2
	./danbooru-change 3dbooru    full  || let EC=$EC+2
	./danbooru-change nekobooru  full  || let EC=$EC+2

	touch ~/doujin/.lastfullupdate ~/doujin/.lastupdate
	exit $EC
else
	echo Unknown mode, run as $0 auto/update/full
	exit 1;
fi;
